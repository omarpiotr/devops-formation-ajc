# SonarQube
## 1-Prerequisites
* Use community edition
* SonarQube installation need minimum JDK 11
* Need database like Postgres or Mysql
* Need SonarScaner for code analysis

## 2-SonarQube Container
* Image : sonarqube:lts-community
* Environment varialbes
    * SONAR_JDBC_UR
    * SONAR_JDBC_USERNAME
    * SONAR_JDBC_PASSWORD
* Volumes :
    * /opt/sonarqube/dat
    * /opt/sonarqube/extensions
    * /opt/sonarqube/log

```yml
services:
  sonarqube:
    image: sonarqube:lts-community
    networks:
      - sonarnet
    hostname: sonarqube
    container_name: sonarqube
    read_only: true
    depends_on:
      db:
        condition: service_healthy
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_temp:/opt/sonarqube/temp
    ports:
      - "9000:9000"
  db:
    image: postgres:17
    networks:
      - sonarnet
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5
    hostname: postgresql
    container_name: postgresql
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonar
    volumes:
      - postgresql:/var/lib/postgresql
      - postgresql_data:/var/lib/postgresql/data

networks:
  sonarnet:
    name: sonarnet
    driver: bridge

volumes:
  sonarqube_data:
  sonarqube_temp:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql:
  postgresql_data:
```
Default login and password are admin / admin and must be changed


## 3-code analysis : SonarScaner

### 3.1 Generate a Token
In SonarQube web Interface generate a `Project | Global analysis token` :
* As an admin :
    * **Administration** > **Security** > **Users** > **update Token**
* As a user :
    * **User** > **My Account** > **Security** 

### 3.2 Configuring the project
* Create a configuration file called `sonar-project.properties`
```properties
# must be unique in a given SonarQube instance
sonar.projectKey=my:project

# sonarQube URL
sonar.host.url=http://localhost:9000

# --- optional properties ---
 
# Path is relative to the sonar-project.properties file. Defaults to .
sonar.sources=.
sonar.exclusions=venv/**/*

# defaults to project key
#sonar.projectName=My project
# defaults to 'not provided'
#sonar.projectVersion=1.0
 
# Encoding of the source code. Default is default system encoding
#sonar.sourceEncoding=UTF-8
``` 
### 3.3 Running SonarScanner CLI from zip file
[( link )](https://docs.sonarsource.com/sonarqube/latest/analyzing-source-code/scanners/sonarscanner/#running-from-zip-file)
* Install SonarScanner CLI 
* Check `sonar-scanner.properties` is configured for your project
* Commands
```bash
# Check sonar-scanner (for windows: sonar-scanner.bat)
sonar-scanner -h

# Fron your project folder run
sonar-scanner -Dsonar.token=myAuthenticationToken
sonar-scanner -Dsonar.login=myAuthenticationToken
# On windows
sonar-scanner "-Dsonar.token=myAuthenticationToken"
sonar-scanner "-Dsonar.login=myAuthenticationToken"
```

### 3.4 Running SonnarScanner CLI for docker container
* ${SONARQUBE_URL} = is the container name used in docker-compose + port
* ${SONAR_AUTHENTICATION_TOKEN} = token authentication generated by SonarQube
* ${SONAR_PROJECT_KEY} = Key Name of the project in SonarQube
* ${YOUR_REPO} = Path of the repos in your host (can ben .)
* sonarnet = must be the same network as Sonarqube on docker

```bash
# From SonarQube documentation SONAR_LOGIN not working 
docker run \
    --rm \
     --network sonarnet \
    -e SONAR_HOST_URL="http://${SONARQUBE_URL}"  \
    -e SONAR_LOGIN="${SONAR_AUTHENTICATION_TOKEN}" \
    -v "${YOUR_REPO}:/usr/src" \
    sonarsource/sonar-scanner-cli

# Using SONAR_SCANNER_OPTS to user Token
docker run \
    --rm \
     --network sonarnet \
    -e SONAR_HOST_URL="http://${SONARQUBE_URL}"  \
    -e SONAR_SCANNER_OPTS="-Dsonar.login="${SONAR_AUTHENTICATION_TOKEN}" -Dsonar.projectKey=${SONAR_PROJECT_KEY}" \
    -v "${YOUR_REPO}:/usr/src" \
    sonarsource/sonar-scanner-cli

# Example : run from your project path (with parameter myToken myProjectKey .)
docker run --rm --network sonarnet -e SONAR_HOST_URL="http://sonarqube:9000" -e SONAR_SCANNER_OPTS="-Dsonar.login=myToken -Dsonar.projectKey=myProjectKey" -v ".:/usr/src" sonarsource/sonar-scanner-cli

```

